<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Dashboard | Africhic Garments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="products.js"></script>
    <script src="product-sync-manager.js"></script>
    <style>
        :root { --brand-gold: #D4AF37; }
        .text-brand-gold { color: #D4AF37; }
        .bg-brand-gold { background-color: #D4AF37; }
        .border-brand-gold { border-color: #D4AF37; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-gold">PRODUCT DASHBOARD</h1>
            <div class="flex gap-4 items-center">
                <button onclick="syncAllProducts()" class="bg-brand-gold text-white px-4 py-2 rounded hover:bg-yellow-600 transition">
                    <i class="fas fa-sync-alt mr-2"></i> Sync Now
                </button>
                <a href="admin-products.html" class="text-gray-600 hover:text-brand-gold">Admin Panel</a>
                <a href="index.html" class="text-gray-600 hover:text-brand-gold">Back to Store</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Status Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="text-gray-600 text-sm">Total Products</p>
                <p class="text-3xl font-bold text-brand-gold" id="stat-total">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="text-gray-600 text-sm">Categories</p>
                <p class="text-3xl font-bold text-gray-800" id="stat-categories">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="text-gray-600 text-sm">Total Stock</p>
                <p class="text-3xl font-bold text-green-600" id="stat-stock">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="text-gray-600 text-sm">Last Sync</p>
                <p class="text-sm font-bold text-gray-800" id="stat-sync">Never</p>
            </div>
        </div>

        <!-- Sync Status Alert -->
        <div id="sync-alert" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3">
            <i class="fas fa-info-circle text-xl"></i>
            <div>
                <p id="sync-message" class="font-semibold"></p>
                <p id="sync-details" class="text-sm mt-1"></p>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="mb-6 flex flex-wrap gap-2">
            <button onclick="filterByCategory('all')" class="px-4 py-2 bg-brand-gold text-white rounded hover:bg-yellow-600 category-filter active" data-category="all">
                All Products
            </button>
            <button onclick="filterByCategory('ladies-dresses')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="ladies-dresses">
                <i class="fas fa-female mr-2"></i> Ladies Dresses
            </button>
            <button onclick="filterByCategory('ladies-skirts')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="ladies-skirts">
                <i class="fas fa-female mr-2"></i> Ladies Skirts
            </button>
            <button onclick="filterByCategory('ladies-tops')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="ladies-tops">
                <i class="fas fa-female mr-2"></i> Ladies Tops
            </button>
            <button onclick="filterByCategory('men-shirts')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="men-shirts">
                <i class="fas fa-male mr-2"></i> Men's Shirts
            </button>
            <button onclick="filterByCategory('men-pants')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="men-pants">
                <i class="fas fa-male mr-2"></i> Men's Pants
            </button>
            <button onclick="filterByCategory('accessories')" class="px-4 py-2 bg-white border border-gray-300 rounded hover:border-brand-gold category-filter" data-category="accessories">
                <i class="fas fa-gem mr-2"></i> Accessories
            </button>
        </div>

        <!-- Products Grid -->
        <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-12">
                <i class="fas fa-spinner text-3xl text-gray-400 animate-spin"></i>
                <p class="text-gray-500 mt-2">Loading products...</p>
            </div>
        </div>

        <!-- No Products Message -->
        <div id="no-products-msg" class="hidden col-span-full text-center py-12">
            <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">No products in this category</p>
        </div>
    </div>

    <script>
        let allProducts = [];
        let currentFilter = 'all';
        let lastSyncTime = localStorage.getItem('lastProductDashboardSync');

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“Š Product Dashboard initializing...');
            
            // Register for real-time updates
            if (window.productSyncManager) {
                window.productSyncManager.onProductsUpdated((products) => {
                    console.log('ðŸ”„ Dashboard received product update:', products.length, 'products');
                    allProducts = products;
                    localStorage.setItem('lastProductDashboardSync', new Date().toLocaleTimeString());
                    updateStats();
                    renderProducts();
                    showSyncNotification('Products updated successfully', 'info');
                });
            }
            
            // Initial load
            loadProducts();
        });

        function loadProducts() {
            if (window.db) {
                window.db.collection('products').get()
                    .then(snapshot => {
                        const products = [];
                        snapshot.forEach(doc => {
                            products.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        allProducts = products;
                        localStorage.setItem('africhic-products', JSON.stringify(products));
                        localStorage.setItem('lastProductDashboardSync', new Date().toLocaleTimeString());
                        
                        console.log('âœ“ Loaded', products.length, 'products from Firestore');
                        updateStats();
                        renderProducts();
                    })
                    .catch(error => {
                        console.error('Error loading products:', error);
                        // Try to load from cache
                        const cached = localStorage.getItem('africhic-products');
                        if (cached) {
                            allProducts = JSON.parse(cached);
                            console.log('âœ“ Loaded', allProducts.length, 'products from cache');
                            updateStats();
                            renderProducts();
                        }
                    });
            } else {
                // Load from cache
                const cached = localStorage.getItem('africhic-products');
                if (cached) {
                    allProducts = JSON.parse(cached);
                    console.log('âœ“ Loaded', allProducts.length, 'products from cache');
                    updateStats();
                    renderProducts();
                }
            }
        }

        function updateStats() {
            const totalProducts = allProducts.length;
            const categories = new Set(allProducts.map(p => p.category));
            const totalStock = allProducts.reduce((sum, p) => sum + (p.stock || 0), 0);
            
            document.getElementById('stat-total').textContent = totalProducts;
            document.getElementById('stat-categories').textContent = categories.size;
            document.getElementById('stat-stock').textContent = totalStock;
            document.getElementById('stat-sync').textContent = localStorage.getItem('lastProductDashboardSync') || 'Never';
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const noMsg = document.getElementById('no-products-msg');
            
            let filtered = allProducts;
            if (currentFilter !== 'all') {
                filtered = allProducts.filter(p => p.category === currentFilter);
            }
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                noMsg.classList.remove('hidden');
                return;
            }
            
            noMsg.classList.add('hidden');
            grid.innerHTML = filtered.map(product => `
                <div class="bg-white rounded-lg shadow hover:shadow-lg transition p-4">
                    <div class="mb-3">
                        <img src="${product.image || 'https://via.placeholder.com/300'}" 
                             alt="${product.name}" 
                             class="w-full h-48 object-cover rounded"
                             onerror="this.src='https://via.placeholder.com/300'">
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${product.category}</p>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description || 'No description'}</p>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-gray-600">Price</p>
                            <p class="font-bold text-brand-gold">R${(product.price || 0).toFixed(2)}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-gray-600">Stock</p>
                            <p class="font-bold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${product.stock || 0}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3 text-xs">
                        ${product.sizes ? `<p class="text-gray-600 mb-1"><strong>Sizes:</strong> ${product.sizes.join(', ')}</p>` : ''}
                        ${product.colours ? `<p class="text-gray-600"><strong>Colours:</strong> ${product.colours.join(', ')}</p>` : ''}
                    </div>
                    
                    <div class="flex gap-2 pt-3 border-t">
                        <a href="admin-products.html" class="flex-1 text-center text-xs bg-brand-gold text-white px-3 py-2 rounded hover:bg-yellow-600 transition">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </a>
                        <button onclick="deleteProduct('${product.id}')" class="flex-1 text-xs bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterByCategory(category) {
            currentFilter = category;
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-brand-gold', 'text-white');
                btn.classList.add('bg-white', 'border', 'border-gray-300');
                if (btn.dataset.category === category) {
                    btn.classList.add('active', 'bg-brand-gold', 'text-white');
                    btn.classList.remove('bg-white', 'border', 'border-gray-300');
                }
            });
            renderProducts();
        }

        async function syncAllProducts() {
            console.log('ðŸ”„ Manual sync triggered...');
            showSyncNotification('Syncing products...', 'info');
            
            try {
                if (window.db) {
                    const snapshot = await window.db.collection('products').get();
                    const products = [];
                    snapshot.forEach(doc => {
                        products.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    allProducts = products;
                    localStorage.setItem('africhic-products', JSON.stringify(products));
                    localStorage.setItem('lastProductDashboardSync', new Date().toLocaleTimeString());
                    
                    updateStats();
                    renderProducts();
                    
                    console.log('âœ“ Sync complete:', products.length, 'products');
                    showSyncNotification('Sync completed successfully!', 'success', products.length + ' products synchronized');
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (error) {
                console.error('Sync failed:', error);
                showSyncNotification('Sync failed: ' + error.message, 'error');
            }
        }

        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            if (window.db) {
                window.db.collection('products').doc(productId).delete()
                    .then(() => {
                        console.log('âœ“ Product deleted:', productId);
                        loadProducts();
                        showSyncNotification('Product deleted successfully', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting product:', error);
                        showSyncNotification('Failed to delete product', 'error');
                    });
            }
        }

        function showSyncNotification(message, type = 'info', details = '') {
            const alert = document.getElementById('sync-alert');
            const msgEl = document.getElementById('sync-message');
            const detailsEl = document.getElementById('sync-details');
            
            alert.classList.remove('hidden', 'bg-blue-50', 'bg-green-50', 'bg-red-50', 'text-blue-700', 'text-green-700', 'text-red-700');
            
            const typeMap = {
                'info': 'bg-blue-50 text-blue-700',
                'success': 'bg-green-50 text-green-700',
                'error': 'bg-red-50 text-red-700'
            };
            
            alert.className = 'mb-6 p-4 rounded-lg flex items-center gap-3 ' + typeMap[type];
            msgEl.textContent = message;
            detailsEl.textContent = details;
            
            if (type !== 'error') {
                setTimeout(() => alert.classList.add('hidden'), 5000);
            }
        }
    </script>
</body>
</html>
