<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management | Africhic Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firestore-sync.js"></script>
    <script src="sync-manager.js"></script>
    <script src="product-sync-manager.js"></script>
    <style>
        :root { --brand-gold: #D4AF37; }
        .text-brand-gold { color: #D4AF37; }
        .bg-brand-gold { background-color: #D4AF37; }
        .input-field { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.25rem; transition: all 0.2s; }
        .input-field:focus { border-color: #D4AF37; outline: none; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-gold">AFRICHIC ADMIN</h1>
            <div class="flex items-center space-x-4">
                <button onclick="syncAllProductsToStore()" class="bg-brand-gold text-white px-3 py-2 rounded text-sm font-medium hover:bg-yellow-600 transition flex items-center gap-2">
                    <i class="fa-solid fa-sync-alt" id="sync-icon"></i>
                    <span id="sync-text">Sync to Store</span>
                </button>
                <a href="product-dashboard.html" class="text-sm font-medium text-gray-600 hover:text-brand-gold">Dashboard</a>
                <a href="admin-orders.html" class="text-sm font-medium text-gray-600 hover:text-brand-gold">Orders</a>
                <a href="index.html" class="text-sm font-medium text-gray-600 hover:text-brand-gold">Back to Store</a>
            </div>
        </div>
    </nav>

    <!-- Sync Status Alert -->
    <div id="sync-status-alert" class="hidden bg-green-50 border-l-4 border-green-600 p-4 max-w-7xl mx-auto mt-4">
        <div class="flex">
            <div>
                <p class="text-sm font-medium text-green-800" id="sync-status-message">Products synced successfully</p>
                <p class="text-xs text-green-700 mt-1" id="sync-status-time"></p>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold mb-8">Product Management</h2>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-sm shadow-md">
                <p class="text-gray-600 text-sm">Total Products</p>
                <p class="text-3xl font-bold text-brand-gold" id="stat-total">0</p>
            </div>
            <div class="bg-white p-6 rounded-sm shadow-md">
                <p class="text-gray-600 text-sm">Categories</p>
                <p class="text-3xl font-bold text-gray-800" id="stat-categories">0</p>
            </div>
            <div class="bg-white p-6 rounded-sm shadow-md">
                <p class="text-gray-600 text-sm">Last Synced</p>
                <p class="text-sm font-bold text-gray-800" id="stat-updated">Never</p>
            </div>
            <div class="bg-white p-6 rounded-sm shadow-md">
                <p class="text-gray-600 text-sm">Sync Status</p>
                <p class="text-lg font-bold text-green-600"><i class="fa-solid fa-check-circle mr-2"></i><span id="sync-status-indicator">Live</span></p>
            </div>
        </div>

        <!-- Add Product Button -->
        <div class="mb-8">
            <button onclick="openProductModal()" class="bg-brand-gold text-white px-6 py-3 rounded-sm font-bold hover:bg-yellow-600 transition">
                <i class="fa-solid fa-plus mr-2"></i>Add New Product
            </button>
        </div>

        <!-- Products Table -->
        <div class="bg-white rounded-sm shadow-md overflow-hidden">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-6 py-4 text-left font-bold">Product</th>
                        <th class="px-6 py-4 text-left font-bold">Price</th>
                        <th class="px-6 py-4 text-left font-bold">Stock</th>
                        <th class="px-6 py-4 text-left font-bold">Colours</th>
                        <th class="px-6 py-4 text-left font-bold">Sizes</th>
                        <th class="px-6 py-4 text-left font-bold">Category</th>
                        <th class="px-6 py-4 text-left font-bold">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                    <!-- Products will be populated here -->
                </tbody>
            </table>
            <div id="no-products-msg" class="hidden text-center py-10 text-gray-500">
                No products yet. <button onclick="openProductModal()" class="text-brand-gold font-bold underline">Add one now!</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-sm shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-brand-gold text-white p-6 flex justify-between items-center sticky top-0">
                <h2 class="text-xl font-bold" id="modal-title">Add New Product</h2>
                <button onclick="closeProductModal()" class="text-2xl cursor-pointer">&times;</button>
            </div>

            <form id="product-form" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Info -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Product Name *</label>
                        <input type="text" id="product-name" class="input-field" placeholder="e.g., Kente Royal Wrap Dress" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2">Price (R) *</label>
                        <input type="number" id="product-price" class="input-field" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2">Stock Quantity *</label>
                        <input type="number" id="product-stock" class="input-field" placeholder="0" min="0" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2">Category *</label>
                        <select id="product-category" class="input-field" required>
                            <option value="">Select Category</option>
                            <option value="ladies-dresses">Ladies Dresses</option>
                            <option value="ladies-skirts">Ladies Skirts</option>
                            <option value="ladies-tops">Ladies Tops</option>
                            <option value="men-shirts">Men's Shirts</option>
                            <option value="men-pants">Men's Pants</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Description</label>
                        <textarea id="product-description" class="input-field" rows="3" placeholder="Product description..."></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Product Image *</label>
                        <div class="flex gap-4 items-start">
                            <div class="flex-1">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-brand-gold hover:bg-yellow-50 transition" onclick="document.getElementById('product-image-file').click()">
                                    <input type="file" id="product-image-file" class="hidden" accept="image/*" required>
                                    <div>
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-brand-gold mb-2"></i>
                                        <p class="text-sm font-medium text-gray-700">Click to upload or drag & drop</p>
                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 5MB</p>
                                    </div>
                                </div>
                                <p id="file-name" class="text-xs text-gray-600 mt-2"></p>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" src="" alt="Preview" class="h-40 w-40 object-cover rounded">
                            </div>
                        </div>
                    </div>

                    <!-- Colours -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Available Colours</label>
                        <div id="colours-container" class="space-y-2 mb-2">
                            <div class="flex gap-2">
                                <input type="text" class="colour-input input-field" placeholder="e.g., Red, Blue, Gold">
                                <button type="button" onclick="removeColourField(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded">Remove</button>
                            </div>
                        </div>
                        <button type="button" onclick="addColourField()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm font-medium">
                            <i class="fa-solid fa-plus mr-2"></i>Add Colour Field
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Enter multiple colours separated by commas in each field</p>
                    </div>

                    <!-- Sizes -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Available Sizes *</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="XS"> XS
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="S"> S
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="M"> M
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="L"> L
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="XL"> XL
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="XXL"> XXL
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="size-checkbox mr-2" value="One Size"> One Size
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 pt-6 border-t">
                    <button type="submit" id="save-product-btn" class="flex-1 bg-brand-gold text-white py-3 rounded font-bold hover:bg-yellow-600 transition">
                        <i class="fa-solid fa-save mr-2"></i>Save Product
                    </button>
                    <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded font-bold hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allProducts = [];
        let editingProductId = null;

        // Initialize
        function initializeProductManagement() {
            loadProducts();
            updateStats();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Image file upload with preview
            const fileInput = document.getElementById('product-image-file');
            if (!fileInput) return; // Exit if form elements not yet loaded
            
            const dropZone = fileInput.parentElement;

            fileInput.addEventListener('change', handleImageUpload);

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-brand-gold', 'bg-yellow-50');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-brand-gold', 'bg-yellow-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-brand-gold', 'bg-yellow-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleImageUpload({ target: fileInput });
                }
            });

            // Form submission - attach directly without cloning
            const form = document.getElementById('product-form');
            if (form && !form.dataset.listenerAttached) {
                form.addEventListener('submit', function(e) {
                    console.log('✓ Form submit event triggered');
                    e.preventDefault();
                    saveProduct();
                });
                form.dataset.listenerAttached = 'true';
            }
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                console.error('FileReader error:', reader.error);
            };
            
            reader.onload = function(event) {
                try {
                    // Compress image to reduce localStorage size
                    const img = new Image();
                    
                    img.onerror = function() {
                        alert('Error loading image. Please try a different image file.');
                        console.error('Image load error');
                        return;
                    };
                    
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Resize image to max 800x800 to reduce size
                            let width = img.width;
                            let height = img.height;
                            const maxDim = 800;
                            
                            if (width > height) {
                                if (width > maxDim) {
                                    height *= maxDim / width;
                                    width = maxDim;
                                }
                            } else {
                                if (height > maxDim) {
                                    width *= maxDim / height;
                                    height = maxDim;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to JPEG with quality 0.7 for better compression
                            window.uploadedImageData = canvas.toDataURL('image/jpeg', 0.7);
                            
                            if (!window.uploadedImageData) {
                                alert('Error converting image. Please try again.');
                                return;
                            }
                            
                            // Show preview
                            document.getElementById('preview-img').src = window.uploadedImageData;
                            document.getElementById('image-preview').classList.remove('hidden');
                            document.getElementById('file-name').textContent = `✓ ${file.name} (optimized)`;
                            console.log('✓ Image uploaded and compressed successfully');
                        } catch (error) {
                            alert('Error processing image: ' + error.message);
                            console.error('Canvas error:', error);
                        }
                    };
                    
                    img.src = event.target.result;
                } catch (error) {
                    alert('Error handling image: ' + error.message);
                    console.error('handleImageUpload error:', error);
                }
            };
            reader.readAsDataURL(file);
        }

        function loadProducts() {
            // Try localStorage first (fastest)
            const storedProducts = localStorage.getItem('africhic-products');
            if (storedProducts) {
                try {
                    allProducts = JSON.parse(storedProducts);
                    // Ensure all products have IDs (only assign if missing)
                    let needsUpdate = false;
                    allProducts = allProducts.map((p, idx) => {
                        if (!p.id) {
                            needsUpdate = true;
                            p.id = 'PROD-' + (p.name || 'unknown').replace(/\s+/g, '-').toLowerCase() + '-' + idx;
                        }
                        return p;
                    });
                    // Save back if we assigned new IDs
                    if (needsUpdate) {
                        localStorage.setItem('africhic-products', JSON.stringify(allProducts));
                        console.log('✓ Assigned missing product IDs');
                    }
                    console.log('✓ Products loaded from localStorage:', allProducts.length, 'items');
                    renderProductsTable();
                    
                    // Also try to load from Firestore in background
                    if (window.db) {
                        getProductsFromFirebase();
                    }
                    return;
                } catch (e) {
                    console.error('Error parsing stored products:', e);
                }
            }
            
            // If no localStorage, try Firestore
            if (window.db) {
                getProductsFromFirebase();
            } else {
                // No products available
                allProducts = [];
                renderProductsTable();
            }
        }

        function getProductsFromFirebase() {
            if (!window.db) {
                console.log('Firebase not available, using localStorage only');
                return;
            }

            window.db.collection('products').get()
                .then(snapshot => {
                    const products = [];
                    snapshot.forEach(doc => {
                        products.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    if (products.length > 0) {
                        allProducts = products;
                        // Save with Firestore IDs to localStorage
                        localStorage.setItem('africhic-products', JSON.stringify(products));
                        renderProductsTable();
                        console.log('✓ Products loaded from Firestore:', products.length, 'items');
                    }
                })
                .catch(error => {
                    console.log('Could not load from Firestore:', error.message);
                });
            
            // Set up real-time listener for Firestore updates
            if (window.firestoreSync && window.firestoreSync.listenToProducts) {
                window.firestoreSync.listenToProducts((products) => {
                    // Ensure all products have Firestore IDs
                    allProducts = products.map((p, idx) => {
                        if (!p.id) {
                            p.id = 'PROD-' + (p.name || 'unknown').replace(/\s+/g, '-').toLowerCase() + '-' + idx;
                        }
                        return p;
                    });
                    localStorage.setItem('africhic-products', JSON.stringify(allProducts));
                    renderProductsTable();
                });
            }
        }

        function renderProductsTable() {
            const tbody = document.getElementById('products-table-body');
            const noMsg = document.getElementById('no-products-msg');

            if (allProducts.length === 0) {
                tbody.innerHTML = '';
                noMsg.classList.remove('hidden');
                return;
            }

            noMsg.classList.add('hidden');
            tbody.innerHTML = allProducts.map((product, idx) => {
                // Final safety check - ensure ID exists
                if (!product.id) {
                    console.warn('⚠️ Product still missing ID:', product.name, '- assigning emergency ID');
                    product.id = 'PROD-' + (product.name || 'unknown').replace(/\s+/g, '-').toLowerCase() + '-' + idx;
                }
                return `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                            <img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                            <div>
                                <p class="font-bold text-gray-800">${product.name}</p>
                                <p class="text-xs text-gray-500">${product.category}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-bold">R ${product.price.toFixed(2)}</td>
                    <td class="px-6 py-4 font-bold">
                        ${product.stock > 0 
                            ? `<span class="text-green-600">${product.stock} in stock</span>` 
                            : `<span class="text-red-600">Out of Stock</span>`}
                    </td>
                    <td class="px-6 py-4 text-xs">
                        ${(product.colours || []).map(c => `<span class="inline-block bg-gray-200 px-2 py-1 rounded mr-1 mb-1">${c}</span>`).join('')}
                    </td>
                    <td class="px-6 py-4 text-xs">
                        ${(product.sizes || []).map(s => `<span class="inline-block bg-brand-gold text-white px-2 py-1 rounded mr-1 mb-1">${s}</span>`).join('')}
                    </td>
                    <td class="px-6 py-4 text-xs">${product.category}</td>
                    <td class="px-6 py-4">
                        <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:underline text-xs">
                            <i class="fa-solid fa-trash mr-1"></i>Delete
                        </button>
                        <button onclick="editProduct('${product.id}')" class="text-blue-600 hover:underline text-xs mr-3">
                            <i class="fa-solid fa-edit mr-1"></i>Edit
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            
            // Save if any emergency IDs were assigned
            localStorage.setItem('africhic-products', JSON.stringify(allProducts));

            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = allProducts.length;
            const now = new Date();
            document.getElementById('stat-updated').textContent = now.toLocaleString();
        }

        function openProductModal() {
            editingProductId = null;
            window.uploadedImageData = null;
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-image-file').value = '';
            document.getElementById('product-image-file').required = true;
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('file-name').textContent = '';
            
            // Reset all size checkboxes
            document.querySelectorAll('.size-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset to single colour field
            document.getElementById('colours-container').innerHTML = `
                <div class="flex gap-2">
                    <input type="text" class="colour-input input-field" placeholder="e.g., Red, Blue, Gold">
                    <button type="button" onclick="removeColourField(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded">Remove</button>
                </div>
            `;
            
            document.getElementById('product-modal').classList.remove('hidden');
            setupEventListeners();
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            editingProductId = null;
        }

        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            window.uploadedImageData = null;
            document.getElementById('modal-title').textContent = 'Edit Product';

            // Populate form
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock || 0;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-image-file').value = '';
            document.getElementById('product-image-file').required = false; // Not required for edit
            document.getElementById('file-name').textContent = '✓ Current image set';

            // Show existing image preview
            document.getElementById('preview-img').src = product.image;
            document.getElementById('image-preview').classList.remove('hidden');

            // Populate colours
            document.getElementById('colours-container').innerHTML = (product.colours || []).map((colour, index) => `
                <div class="flex gap-2">
                    <input type="text" class="colour-input input-field" value="${colour}" placeholder="e.g., Red, Blue, Gold">
                    <button type="button" onclick="removeColourField(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded">Remove</button>
                </div>
            `).join('');

            // Populate sizes
            document.querySelectorAll('.size-checkbox').forEach(checkbox => {
                checkbox.checked = (product.sizes || []).includes(checkbox.value);
            });

            document.getElementById('product-modal').classList.remove('hidden');
            setupEventListeners();
        }

        function addColourField() {
            const container = document.getElementById('colours-container');
            const newField = document.createElement('div');
            newField.className = 'flex gap-2';
            newField.innerHTML = `
                <input type="text" class="colour-input input-field" placeholder="e.g., Red, Blue, Gold">
                <button type="button" onclick="removeColourField(this)" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded">Remove</button>
            `;
            container.appendChild(newField);
        }

        function removeColourField(button) {
            button.parentElement.remove();
        }

        async function saveProduct() {
            console.log('=== SAVE PRODUCT STARTED ===');
            try {
                const name = document.getElementById('product-name')?.value?.trim() || '';
                const priceInput = document.getElementById('product-price')?.value?.trim() || '';
                const price = priceInput ? parseFloat(priceInput) : NaN;
                const stockInput = document.getElementById('product-stock')?.value?.trim() || '';
                const stock = stockInput ? parseInt(stockInput) : 0;
                const category = document.getElementById('product-category')?.value || '';
                const description = document.getElementById('product-description')?.value || '';
                const image = window.uploadedImageData || (editingProductId && allProducts.find(p => p.id === editingProductId)?.image);

                // Get colours
                const colours = [];
                document.querySelectorAll('.colour-input').forEach(input => {
                    if (input.value.trim()) {
                        colours.push(...input.value.split(',').map(c => c.trim()));
                    }
                });

                // Get sizes
                const sizes = Array.from(document.querySelectorAll('.size-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                // Validation
                console.log('Validation check - Name:', name, 'Price:', price, 'Category:', category, 'Image:', image ? 'yes' : 'no', 'Colours:', colours.length, 'Sizes:', sizes.length);
                
                if (!name || isNaN(price) || !category || !image || colours.length === 0 || sizes.length === 0) {
                    const missingFields = [];
                    if (!name) missingFields.push('Product Name');
                    if (isNaN(price)) missingFields.push('Price');
                    if (!category) missingFields.push('Category');
                    if (!image) missingFields.push('Product Image');
                    if (colours.length === 0) missingFields.push('At least one Colour');
                    if (sizes.length === 0) missingFields.push('At least one Size');
                    alert('Please fill all required fields:\n✗ ' + missingFields.join('\n✗ '));
                    return;
                }

                let result;
                if (editingProductId) {
                    // Update existing product using ProductSyncManager
                    result = await window.productSyncManager.updateProduct(editingProductId, {
                        name,
                        price,
                        stock,
                        category,
                        description,
                        image,
                        colours,
                        sizes
                    });
                    console.log('✓ Product updated via ProductSyncManager');
                } else {
                    // Create new product using ProductSyncManager
                    result = await window.productSyncManager.addProduct({
                        name,
                        price,
                        stock,
                        category,
                        description,
                        image,
                        colours,
                        sizes
                    });
                    console.log('✓ New product created via ProductSyncManager');
                }

                // Reload products from localStorage to get updates
                loadProducts();
                
                // Update UI
                renderProductsTable();
                closeProductModal();
                
                // Success feedback
                if (editingProductId) {
                    alert('✅ Product updated! Changes are instantly synced to all stores.');
                } else {
                    alert('✅ Product added! It\'s now live on all stores.');
                }
                
                console.log('=== SAVE PRODUCT COMPLETED ===');
            } catch (error) {
                console.error('❌ ERROR in saveProduct:', error.message);
                console.error('Stack:', error.stack);
                alert('❌ Error: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                // Delete using ProductSyncManager
                await window.productSyncManager.deleteProduct(productId);
                
                // Reload and refresh UI
                loadProducts();
                renderProductsTable();
                
                alert('✅ Product deleted! The update is instantly synced to all stores.');
            } catch (error) {
                console.error('❌ Error deleting product:', error);
                alert('❌ Error deleting product: ' + error.message);
            }
        }

        function broadcastProductUpdate() {
            // Notify shop page in real-time
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ type: 'PRODUCTS_UPDATED' }, '*');
            }

            // Dispatch custom event for any open shop pages
            window.dispatchEvent(new CustomEvent('productsUpdated', { 
                detail: { products: allProducts }
            }));

            // Store update timestamp
            localStorage.setItem('africhic-products-updated', Date.now());
        }

        // Listen for updates from other tabs
        window.addEventListener('storage', function(e) {
            if (e.key === 'africhic-products') {
                loadProducts();
            }
        });

        // Set up real-time Firestore listener for live updates
        function setupFirestoreListener() {
            if (!window.db) return;
            
            window.db.collection('products').onSnapshot(
                (snapshot) => {
                    const products = [];
                    snapshot.forEach(doc => {
                        products.push(doc.data());
                    });
                    
                    if (products.length > 0) {
                        allProducts = products;
                        localStorage.setItem('africhic-products', JSON.stringify(products));
                        renderProductsTable();
                        console.log('✓ Real-time update from Firestore:', products.length, 'products');
                    }
                },
                (error) => {
                    console.log('Firestore listener error (not critical):', error.message);
                }
            );
        }

        // Initialize on page load
        initializeProductManagement();
        
        // Set up real-time listener after a short delay
        setTimeout(setupFirestoreListener, 2000);

        // Sync all products to store for guests and logged-in users
        async function syncAllProductsToStore() {
            const syncBtn = document.querySelector('[onclick="syncAllProductsToStore()"]');
            const syncIcon = document.getElementById('sync-icon');
            const syncText = document.getElementById('sync-text');
            const alert = document.getElementById('sync-status-alert');
            const alertMsg = document.getElementById('sync-status-message');
            const alertTime = document.getElementById('sync-status-time');

            try {
                syncBtn.disabled = true;
                syncIcon.classList.add('animate-spin');
                syncText.textContent = 'Syncing...';

                // Get all products from database
                const products = allProducts;
                
                if (products.length === 0) {
                    alert('⚠️ No products to sync. Please add some products first.');
                    return;
                }

                // Sync via ProductSyncManager
                if (window.productSyncManager) {
                    await window.productSyncManager.saveProducts(products);
                }

                // Also force sync to Firestore
                if (window.db) {
                    const batch = window.db.batch();
                    products.forEach(product => {
                        const docRef = window.db.collection('products').doc(product.id);
                        batch.set(docRef, {
                            ...product,
                            syncedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    });
                    await batch.commit();
                }

                // Update UI
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                
                alertMsg.textContent = `✓ Successfully synced ${products.length} products to all stores`;
                alertTime.textContent = `Synced at ${timeStr}. All guests and logged-in users will see updates immediately.`;
                alert.classList.remove('hidden');

                document.getElementById('stat-updated').textContent = timeStr;
                document.getElementById('sync-status-indicator').textContent = 'Live';

                // Hide alert after 5 seconds
                setTimeout(() => {
                    alert.classList.add('hidden');
                }, 5000);

                console.log('✓ All products synced to store for guests and logged-in users');

            } catch (error) {
                console.error('Sync failed:', error);
                alertMsg.textContent = `❌ Sync failed: ${error.message}`;
                alert.classList.remove('hidden');
                alertMsg.className = 'text-sm font-medium text-red-800';
            } finally {
                syncBtn.disabled = false;
                syncIcon.classList.remove('animate-spin');
                syncText.textContent = 'Sync to Store';
            }
        }
    </script>

</body>
</html>
